{% load static %}
{% comment %}
=============================================================================
Sidebar Component - Modern Design
=============================================================================

Reusable sidebar with:
    - Search box
    - Categories list
    - Tags cloud
    - Recent comments
    - Newsletter signup

=============================================================================
{% endcomment %}

<!-- Search Widget -->
<div class="sidebar-widget mb-4">
    <div class="widget-header">
        <i class="bi bi-search"></i>
        <span>Search</span>
    </div>
    <div class="widget-body">
        <form action="{% url 'blog:search' %}" method="GET">
            <div class="input-group">
                <input type="search" name="q" class="form-control"
                       placeholder="Search posts..." value="{{ request.GET.q }}">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Categories Widget -->
<div class="sidebar-widget mb-4">
    <div class="widget-header">
        <i class="bi bi-folder2"></i>
        <span>Categories</span>
    </div>
    <div class="widget-body p-0">
        <ul class="list-group list-group-flush">
            {% for category in all_categories %}
            <li class="list-group-item d-flex justify-content-between align-items-center category-item">
                <a href="{{ category.get_absolute_url }}" class="category-link">
                    <i class="bi bi-chevron-right me-2 text-primary"></i>
                    {{ category.name }}
                </a>
                <span class="badge bg-primary-subtle text-primary rounded-pill">
                    {{ category.post_count }}
                </span>
            </li>
            {% empty %}
            <li class="list-group-item text-muted text-center py-4">
                <i class="bi bi-folder-x d-block mb-2" style="font-size: 1.5rem;"></i>
                No categories yet
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Tags Widget -->
<div class="sidebar-widget mb-4">
    <div class="widget-header">
        <i class="bi bi-tags"></i>
        <span>Tags</span>
    </div>
    <div class="widget-body">
        <div class="tags-cloud">
            {% for tag in all_tags %}
            <a href="{{ tag.get_absolute_url }}" class="tag-badge">
                {{ tag.name }}
            </a>
            {% empty %}
            <div class="text-muted text-center py-3">
                <i class="bi bi-tag-x d-block mb-2" style="font-size: 1.5rem;"></i>
                No tags yet
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Recent Comments Widget -->
{% if recent_comments %}
<div class="sidebar-widget mb-4">
    <div class="widget-header">
        <i class="bi bi-chat-square-text"></i>
        <span>Recent Comments</span>
    </div>
    <div class="widget-body p-0">
        {% for comment in recent_comments %}
        <div class="comment-item {% if not forloop.last %}border-bottom{% endif %}">
            <div class="d-flex">
                <div class="avatar-initials me-3" style="width: 36px; height: 36px; font-size: 0.8rem;">
                    {{ comment.author.username|slice:":1"|upper }}
                </div>
                <div class="flex-grow-1 min-width-0">
                    <div class="comment-meta mb-1">
                        <strong class="text-dark">{{ comment.author.username }}</strong>
                        <span class="text-muted">on</span>
                    </div>
                    <a href="{{ comment.post.get_absolute_url }}#comment-{{ comment.id }}"
                       class="comment-post-link d-block text-truncate mb-1">
                        {{ comment.post.title }}
                    </a>
                    <p class="comment-preview text-muted mb-0">
                        "{{ comment.content|truncatechars:60 }}"
                    </p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Newsletter Widget -->
<div class="sidebar-widget newsletter-widget mb-4">
    <div class="widget-body text-center">
        <div class="newsletter-icon mb-3">
            <i class="bi bi-envelope-paper"></i>
        </div>
        <h5 class="fw-bold text-white mb-2">Stay Updated</h5>
        <p class="text-white-50 small mb-3">
            Get the latest posts and updates delivered to your inbox.
        </p>
        <form class="newsletter-form" id="newsletter-form" action="{% url 'blog:newsletter_subscribe' %}" method="POST">
            {% csrf_token %}
            <div class="input-group mb-2">
                <input type="email" name="email" class="form-control" placeholder="Enter your email" required id="newsletter-email">
                <button class="btn btn-light" type="submit" id="newsletter-btn">
                    <i class="bi bi-send"></i>
                </button>
            </div>
            <div id="newsletter-message" class="small mb-2" style="display: none;"></div>
            <small class="text-white-50">We respect your privacy. Unsubscribe anytime.</small>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('newsletter-form');
    const emailInput = document.getElementById('newsletter-email');
    const messageDiv = document.getElementById('newsletter-message');
    const submitBtn = document.getElementById('newsletter-btn');

    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const email = emailInput.value.trim();
            if (!email) return;

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: 'email=' + encodeURIComponent(email)
            })
            .then(response => response.json())
            .then(data => {
                messageDiv.style.display = 'block';
                if (data.success) {
                    messageDiv.className = 'small mb-2 text-white';
                    messageDiv.innerHTML = '<i class="bi bi-check-circle me-1"></i>' + data.message;
                    emailInput.value = '';
                } else {
                    messageDiv.className = 'small mb-2 text-warning';
                    messageDiv.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>' + data.message;
                }
            })
            .catch(error => {
                messageDiv.style.display = 'block';
                messageDiv.className = 'small mb-2 text-warning';
                messageDiv.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Something went wrong. Please try again.';
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-send"></i>';
            });
        });
    }
});
</script>

<!-- Author Card (if viewing a post) -->
{% if post and post.author %}
<div class="sidebar-widget author-widget mb-4">
    <div class="widget-header">
        <i class="bi bi-person-circle"></i>
        <span>About Author</span>
    </div>
    <div class="widget-body text-center">
        <div class="author-avatar mx-auto mb-3">
            {% if post.author.profile.avatar and post.author.profile.avatar.name %}
            <img src="{{ post.author.profile.avatar.url }}"
                 alt="{{ post.author.username }}"
                 class="rounded-circle"
                 width="80" height="80"
                 style="object-fit: cover;">
            {% else %}
            <div class="avatar-initials mx-auto" style="width: 80px; height: 80px; font-size: 2rem;">
                {{ post.author.username|slice:":1"|upper }}
            </div>
            {% endif %}
        </div>
        <h6 class="fw-bold mb-1">{{ post.author.profile.full_name }}</h6>
        <p class="text-muted small mb-2">@{{ post.author.username }}</p>
        {% if post.author.profile.bio %}
        <p class="small text-muted mb-3">{{ post.author.profile.bio|truncatechars:100 }}</p>
        {% endif %}
        <div class="author-stats d-flex justify-content-center gap-4 text-center mb-3">
            <div>
                <span class="d-block fw-bold text-primary">{{ post.author.profile.post_count }}</span>
                <small class="text-muted">Posts</small>
            </div>
            <div>
                <span class="d-block fw-bold text-primary">{{ post.author.profile.comment_count }}</span>
                <small class="text-muted">Comments</small>
            </div>
        </div>
        <a href="{% url 'accounts:profile_detail' username=post.author.username %}"
           class="btn btn-outline-primary btn-sm">
            View Profile
        </a>
    </div>
</div>
{% endif %}
